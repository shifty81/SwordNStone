name: Build Validation

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

# Limit permissions for security
permissions:
  contents: read

jobs:
  validate-project-files:
    name: Validate Project References
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for .cs files not in .csproj
      run: |
        #!/bin/bash
        set -e
        
        echo "Checking project file completeness..."
        errors=0
        warnings=0
        
        for csproj in $(find . -name "*.csproj"); do
          echo "Checking $csproj..."
          dir=$(dirname "$csproj")
          
          # Find all .cs and .ci.cs files (excluding generated files)
          while IFS= read -r csfile; do
            # Skip generated files
            if [[ "$csfile" == *"Packet.Serializer"* ]] || \
               [[ "$csfile" == *"AssemblyInfo"* ]] || \
               [[ "$csfile" == *"obj/"* ]] || \
               [[ "$csfile" == *"bin/"* ]]; then
              continue
            fi
            
            # Get relative path
            rel_path=$(realpath --relative-to="$dir" "$csfile" || echo "$csfile")
            filename=$(basename "$csfile")
            
            # Check if file is referenced in csproj (by filename)
            if ! grep -q "$filename" "$csproj"; then
              echo "❌ ERROR: $csfile not referenced in $csproj"
              errors=$((errors + 1))
            fi
          done < <(find "$dir" -name "*.cs" -o -name "*.ci.cs" 2>/dev/null)
        done
        
        if [ $errors -gt 0 ]; then
          echo ""
          echo "❌ Found $errors file(s) not included in project files!"
          echo "Please add these files to the appropriate .csproj file."
          echo "This will cause CS0246 'type or namespace not found' errors."
          exit 1
        fi
        
        echo "✅ All source files are properly referenced in project files."
    
    - name: Check for CiTo syntax issues
      run: |
        #!/bin/bash
        echo "Checking for common CiTo transpilation issues..."
        issues=0
        
        # Check for array indexing within IntRef.Create (more specific pattern)
        if grep -rn 'IntRef\.Create([^)]*\[[^]]*\]' --include="*.ci.cs" SwordAndStoneLib/ | grep -v "//"; then
          echo "⚠️  WARNING: Found array indexing within IntRef.Create"
          echo "This may cause 'Expected CiClassPtrType, got CiArrayPtrType' errors"
          echo "Consider extracting to intermediate variables"
          echo "Example: int val = array[index]; IntRef.Create(val);"
          issues=$((issues + 1))
        fi
        
        if [ $issues -eq 0 ]; then
          echo "✅ No obvious CiTo syntax issues found"
        else
          echo "⚠️  Found $issues potential CiTo issues"
        fi

  check-code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for common issues
      run: |
        #!/bin/bash
        echo "Checking for common code quality issues..."
        
        # Check for unused variables (basic pattern matching)
        echo "Checking for potential unused variables..."
        grep -rn "int .* = .*;" --include="*.cs" --include="*.ci.cs" | grep -v "return" | grep -v "//" || true
        
        # Check for TODO/FIXME comments
        echo "Checking for TODO/FIXME comments..."
        todos=$(grep -rn "TODO\|FIXME" --include="*.cs" --include="*.ci.cs" || true)
        if [ -n "$todos" ]; then
          echo "Found TODO/FIXME comments (informational):"
          echo "$todos"
        fi
        
        echo "✅ Code quality check complete."
  
  check-dependencies:
    name: Check Build Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Validate packages.config
      run: |
        #!/bin/bash
        echo "Checking NuGet package configurations..."
        errors=0
        
        # Check that packages.config files are well-formed XML
        for pkg_config in $(find . -name "packages.config"); do
          echo "Checking $pkg_config..."
          if command -v xmllint &> /dev/null; then
            if ! xmllint --noout "$pkg_config" 2>/dev/null; then
              echo "❌ ERROR: $pkg_config has invalid XML"
              errors=$((errors + 1))
            fi
          fi
        done
        
        # Check for required packages
        echo "Checking for required package references..."
        if [ -f "SwordAndStoneLib/packages.config" ]; then
          if ! grep -q "protobuf-net" "SwordAndStoneLib/packages.config"; then
            echo "❌ ERROR: protobuf-net not found in SwordAndStoneLib/packages.config"
            errors=$((errors + 1))
          else
            echo "✅ protobuf-net package referenced"
          fi
        fi
        
        if [ -f "SwordAndStone/packages.config" ]; then
          if ! grep -q "OpenTK" "SwordAndStone/packages.config"; then
            echo "❌ ERROR: OpenTK not found in SwordAndStone/packages.config"
            errors=$((errors + 1))
          else
            echo "✅ OpenTK package referenced"
          fi
        fi
        
        if [ $errors -gt 0 ]; then
          echo ""
          echo "❌ Found $errors dependency configuration errors!"
          exit 1
        fi
        
        echo "✅ All package configurations are valid"
    
    - name: Check build tools
      run: |
        #!/bin/bash
        echo "Checking for required build tools..."
        missing=0
        
        if [ ! -f "CiTo.exe" ]; then
          echo "❌ ERROR: CiTo.exe not found"
          missing=$((missing + 1))
        else
          echo "✅ CiTo.exe found"
        fi
        
        if [ ! -f "CodeGenerator.exe" ]; then
          echo "❌ ERROR: CodeGenerator.exe not found"
          missing=$((missing + 1))
        else
          echo "✅ CodeGenerator.exe found"
        fi
        
        if [ ! -f "Packet.proto" ]; then
          echo "❌ ERROR: Packet.proto not found"
          missing=$((missing + 1))
        else
          echo "✅ Packet.proto found"
        fi
        
        if [ $missing -gt 0 ]; then
          echo ""
          echo "❌ Missing $missing required build tools!"
          echo "Build will fail with metadata errors"
          exit 1
        fi
        
        echo "✅ All required build tools present"

  build-windows:
    name: Build on Windows (Full)
    runs-on: windows-latest
    # Only run on main branches or PRs to avoid excessive CI usage
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      
    - name: Restore NuGet packages
      run: nuget restore SwordAndStone.sln
      continue-on-error: true
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
      
    - name: Build Solution (informational only - requires Mono)
      run: |
        # Note: Full build requires Mono for code generation
        # This is informational only to check project structure
        echo "Full build requires Mono for CodeGenerator.exe"
        echo "Build validation focuses on project file completeness"
      continue-on-error: true
      
    - name: Report Build Status
      run: |
        echo "Build validation completed."
        echo "Note: Full build requires Mono for code generation (CodeGenerator.exe)"

  lint-config:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Validate XML files
      run: |
        echo "Validating XML configuration files..."
        for xml in $(find . -name "*.csproj" -o -name "*.config" -o -name "*.xml"); do
          if ! xmllint --noout "$xml" 2>/dev/null; then
            echo "❌ Invalid XML: $xml"
            exit 1
          fi
        done
        echo "✅ All XML files are valid."
      
    - name: Check EditorConfig
      run: |
        if [ -f ".editorconfig" ]; then
          echo "✅ .editorconfig found."
        else
          echo "⚠️ No .editorconfig file found. Consider adding one for consistency."
        fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-project-files, check-code-quality, check-dependencies, lint-config]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## Build Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ All validation checks completed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Project file validation (prevents CS0246 errors)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ CiTo syntax validation (prevents transpilation errors)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Dependency validation (prevents CS0006 metadata errors)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Code quality checks" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Configuration validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Purpose:" >> $GITHUB_STEP_SUMMARY
        echo "These validations prevent common metadata and build errors that occur when:" >> $GITHUB_STEP_SUMMARY
        echo "- New files are added but not included in project files" >> $GITHUB_STEP_SUMMARY
        echo "- CiTo syntax errors cause transpilation failures" >> $GITHUB_STEP_SUMMARY
        echo "- NuGet packages are not properly configured" >> $GITHUB_STEP_SUMMARY
        echo "- Build dependencies are missing" >> $GITHUB_STEP_SUMMARY
