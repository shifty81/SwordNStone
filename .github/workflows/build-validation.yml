name: Build Validation

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

jobs:
  validate-project-files:
    name: Validate Project References
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for .cs files not in .csproj
      run: |
        #!/bin/bash
        set -e
        
        echo "Checking project file completeness..."
        errors=0
        
        for csproj in $(find . -name "*.csproj"); do
          echo "Checking $csproj..."
          dir=$(dirname "$csproj")
          
          # Find all .cs and .ci.cs files (excluding generated files)
          while IFS= read -r csfile; do
            # Skip generated files
            if [[ "$csfile" == *"Packet.Serializer"* ]] || \
               [[ "$csfile" == *"AssemblyInfo"* ]] || \
               [[ "$csfile" == *"obj/"* ]] || \
               [[ "$csfile" == *"bin/"* ]]; then
              continue
            fi
            
            # Get relative path
            rel_path=$(realpath --relative-to="$dir" "$csfile" || echo "$csfile")
            filename=$(basename "$csfile")
            
            # Check if file is referenced in csproj (by filename)
            if ! grep -q "$filename" "$csproj"; then
              echo "❌ ERROR: $csfile not referenced in $csproj"
              errors=$((errors + 1))
            fi
          done < <(find "$dir" -name "*.cs" -o -name "*.ci.cs" 2>/dev/null)
        done
        
        if [ $errors -gt 0 ]; then
          echo ""
          echo "❌ Found $errors file(s) not included in project files!"
          echo "Please add these files to the appropriate .csproj file."
          exit 1
        fi
        
        echo "✅ All source files are properly referenced in project files."

  check-code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for common issues
      run: |
        #!/bin/bash
        echo "Checking for common code quality issues..."
        
        # Check for unused variables (basic pattern matching)
        echo "Checking for potential unused variables..."
        grep -rn "int .* = .*;" --include="*.cs" --include="*.ci.cs" | grep -v "return" | grep -v "//" || true
        
        # Check for TODO/FIXME comments
        echo "Checking for TODO/FIXME comments..."
        todos=$(grep -rn "TODO\|FIXME" --include="*.cs" --include="*.ci.cs" || true)
        if [ -n "$todos" ]; then
          echo "Found TODO/FIXME comments (informational):"
          echo "$todos"
        fi
        
        echo "✅ Code quality check complete."

  build-windows:
    name: Build on Windows (Full)
    runs-on: windows-latest
    # Only run on main branches or PRs to avoid excessive CI usage
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      
    - name: Restore NuGet packages
      run: nuget restore SwordAndStone.sln
      continue-on-error: true
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
      
    - name: Build Solution (without code generation)
      run: |
        # Build without the pre-build code generation step
        msbuild SwordAndStone.sln /p:Configuration=Debug /p:BuildProjectReferences=false /p:SkipCompilerExecution=true /t:Compile
      continue-on-error: true
      
    - name: Report Build Status
      run: |
        echo "Build validation completed."
        echo "Note: Full build requires Mono for code generation (CodeGenerator.exe)"

  lint-config:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Validate XML files
      run: |
        echo "Validating XML configuration files..."
        for xml in $(find . -name "*.csproj" -o -name "*.config" -o -name "*.xml"); do
          if ! xmllint --noout "$xml" 2>/dev/null; then
            echo "❌ Invalid XML: $xml"
            exit 1
          fi
        done
        echo "✅ All XML files are valid."
      
    - name: Check EditorConfig
      run: |
        if [ -f ".editorconfig" ]; then
          echo "✅ .editorconfig found."
        else
          echo "⚠️ No .editorconfig file found. Consider adding one for consistency."
        fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-project-files, check-code-quality, lint-config]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## Build Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ All validation checks completed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Project file validation" >> $GITHUB_STEP_SUMMARY
        echo "- Code quality checks" >> $GITHUB_STEP_SUMMARY
        echo "- Configuration validation" >> $GITHUB_STEP_SUMMARY
