#!/bin/bash
# Pre-commit hook for SwordNStone project
# Validates project files and prevents commits with obvious build issues
# 
# To install this hook:
#   cp .git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

echo "================================"
echo "Pre-commit validation..."
echo "================================"

ERRORS=0

# 1. Check if any .ci.cs files were added/modified
echo "Checking for .ci.cs file changes..."
MODIFIED_CI_FILES=$(git diff --cached --name-only --diff-filter=AM | grep '\.ci\.cs$' || true)

if [ -n "$MODIFIED_CI_FILES" ]; then
    echo "Found modified .ci.cs files:"
    echo "$MODIFIED_CI_FILES"
    
    # Check if files are in .csproj
    for file in $MODIFIED_CI_FILES; do
        filename=$(basename "$file")
        if [ "$filename" != "Packet.Serializer.ci.cs" ]; then
            if [ -f "SwordAndStoneLib/SwordAndStoneLib.csproj" ]; then
                if ! grep -q "$filename" "SwordAndStoneLib/SwordAndStoneLib.csproj"; then
                    echo "ERROR: $filename not found in SwordAndStoneLib.csproj"
                    echo "Please add it to the project file"
                    ERRORS=$((ERRORS + 1))
                fi
            fi
        fi
    done
    
    # Check for common CiTo issues in modified files
    for file in $MODIFIED_CI_FILES; do
        if [ -f "$file" ]; then
            # Check for complex nested array expressions in IntRef.Create
            if grep -n 'IntRef\.Create.*\[.*\].*\[.*\]' "$file"; then
                echo "WARNING: Complex nested array expression in IntRef.Create found in $file"
                echo "Consider extracting to intermediate variable"
                echo "This may cause CiTo transpilation errors"
            fi
        fi
    done
fi

# 2. Check if any .cs files were added (non-.ci.cs)
MODIFIED_CS_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.cs$' | grep -v '\.ci\.cs$' | grep 'SwordAndStoneLib/' || true)

if [ -n "$MODIFIED_CS_FILES" ]; then
    echo "Found new .cs files:"
    echo "$MODIFIED_CS_FILES"
    
    for file in $MODIFIED_CS_FILES; do
        filename=$(basename "$file")
        if [ -f "SwordAndStoneLib/SwordAndStoneLib.csproj" ]; then
            if ! grep -q "$filename" "SwordAndStoneLib/SwordAndStoneLib.csproj"; then
                echo "WARNING: $filename not found in SwordAndStoneLib.csproj"
                echo "Please add it to the project file if it's a source file"
            fi
        fi
    done
fi

# 3. Check if .csproj files are well-formed
MODIFIED_CSPROJ=$(git diff --cached --name-only | grep '\.csproj$' || true)

if [ -n "$MODIFIED_CSPROJ" ]; then
    echo "Checking modified .csproj files..."
    for proj in $MODIFIED_CSPROJ; do
        if [ -f "$proj" ]; then
            if command -v xmllint &> /dev/null; then
                if ! xmllint --noout "$proj" 2>/dev/null; then
                    echo "ERROR: $proj has invalid XML"
                    ERRORS=$((ERRORS + 1))
                fi
            else
                # Basic check
                if ! grep -q "<Project" "$proj" || ! grep -q "</Project>" "$proj"; then
                    echo "ERROR: $proj missing Project tags"
                    ERRORS=$((ERRORS + 1))
                fi
            fi
        fi
    done
fi

# 4. Check if packages.config was modified
MODIFIED_PACKAGES=$(git diff --cached --name-only | grep 'packages\.config$' || true)

if [ -n "$MODIFIED_PACKAGES" ]; then
    echo "WARNING: packages.config modified"
    echo "Remember to run: nuget restore SwordAndStone.sln"
    echo "And document new dependencies in BUILD.md"
fi

# 5. Remind about validation
if [ -n "$MODIFIED_CI_FILES" ] || [ -n "$MODIFIED_CS_FILES" ]; then
    echo ""
    echo "REMINDER: Have you run pre-build-validation?"
    echo "  ./pre-build-validation.sh (Linux/Mac)"
    echo "  pre-build-validation.bat (Windows)"
    echo ""
fi

# Summary
if [ $ERRORS -gt 0 ]; then
    echo "================================"
    echo "Pre-commit validation FAILED"
    echo "Errors: $ERRORS"
    echo "================================"
    echo "Please fix the errors before committing"
    exit 1
fi

echo "================================"
echo "Pre-commit validation passed"
echo "================================"
exit 0
